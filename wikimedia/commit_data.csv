Repository,File,Commit Message
wikimedia/operations-puppet,modules/profile/templates/mariadb/grants/production-m3.sql.erb,"mariadb: update grants for phab2002 with new IP

As part of the VLAN migration,
https://wikitech.wikimedia.org/wiki/Vlan_migration,

this server has changed IP addresses from 10.192.32.54
to 10.92.27.6 (private1-c-codfw -> private1-c3-codfw).

Please update the grants accordingly.

Bug: T377374
Change-Id: I0ce83e483a8e3e93ba0d57e2438998f7674265f0"
wikimedia/operations-puppet,modules/varnish/templates/browsersec.body.html.erb,"varnish: Give 1% of views RSA cert warnings

We're giving users occasional warnings so they have ample time to
address their outdated browsers.

Bug: T370837
Change-Id: I242786762742ec7e73801b1c7b87f30f8698cc6f"
wikimedia/operations-puppet,modules/varnish/templates/wikimedia-frontend.vcl.erb,"varnish: Give 1% of views RSA cert warnings

We're giving users occasional warnings so they have ample time to
address their outdated browsers.

Bug: T370837
Change-Id: I242786762742ec7e73801b1c7b87f30f8698cc6f"
wikimedia/operations-puppet,modules/varnish/templates/upload-frontend.inc.vcl.erb,"varnish: add pediapress.com to allowed maps domains

Per the request in the task below, add pediapress.com to the list of
allowed domains for maps usage.

Hosts: cp1101.eqiad.wmnet
Bug: T375761
Change-Id: I4fe4fed4ba526a86f7927682e0a32516f53a805f"
wikimedia/operations-puppet,modules/lvs/manifests/kernel_config.pp,"LVS: Only allow IPv6 default route from RAs on primary interface

Adjusts sysctl's so that 'net.ipv6.conf.default.accept_ra' is set
to 1 for all ints, ensuring that IPv6 address autoconfiguration
will take place, but settting 'net.ipv6.conf.all.accept_ra_defrtr'
to 0, so by default RA processing on an interface doesn't cause
a default route to be added.

Then we explicitly enable accept_ra_defrtr for the primary interface
so that we get the required default route only on that one.

We do this only on the backup LVS in codfw, lvs2014 to start with before
rolling it out everywhere else.

Bug: T358260
Hosts: lvs2014.codfw.wmnet, lvs1020.eqiad.wmnet, lvs4010.ulsfo.wmnet
Change-Id: I574b55177ef6d11c1524110a6bcc145c8fbc155d"
wikimedia/operations-puppet,modules/profile/manifests/lvs.pp,"LVS: Only allow IPv6 default route from RAs on primary interface

Adjusts sysctl's so that 'net.ipv6.conf.default.accept_ra' is set
to 1 for all ints, ensuring that IPv6 address autoconfiguration
will take place, but settting 'net.ipv6.conf.all.accept_ra_defrtr'
to 0, so by default RA processing on an interface doesn't cause
a default route to be added.

Then we explicitly enable accept_ra_defrtr for the primary interface
so that we get the required default route only on that one.

We do this only on the backup LVS in codfw, lvs2014 to start with before
rolling it out everywhere else.

Bug: T358260
Hosts: lvs2014.codfw.wmnet, lvs1020.eqiad.wmnet, lvs4010.ulsfo.wmnet
Change-Id: I574b55177ef6d11c1524110a6bcc145c8fbc155d"
wikimedia/operations-puppet,modules/profile/manifests/lvs/interface_tweaks.pp,"LVS: Only allow IPv6 default route from RAs on primary interface

Adjusts sysctl's so that 'net.ipv6.conf.default.accept_ra' is set
to 1 for all ints, ensuring that IPv6 address autoconfiguration
will take place, but settting 'net.ipv6.conf.all.accept_ra_defrtr'
to 0, so by default RA processing on an interface doesn't cause
a default route to be added.

Then we explicitly enable accept_ra_defrtr for the primary interface
so that we get the required default route only on that one.

We do this only on the backup LVS in codfw, lvs2014 to start with before
rolling it out everywhere else.

Bug: T358260
Hosts: lvs2014.codfw.wmnet, lvs1020.eqiad.wmnet, lvs4010.ulsfo.wmnet
Change-Id: I574b55177ef6d11c1524110a6bcc145c8fbc155d"
wikimedia/operations-puppet,modules/profile/manifests/analytics/refinery/job/refine.pp,"[analytics][refine] Use deduplication fix backport in legacy Refine job

See the original commit here:
https://gerrit.wikimedia.org/r/c/analytics/refinery/source/+/1080306

And the backport here:
https://gerrit.wikimedia.org/r/c/analytics/refinery/source/+/1081164

Bug: T369845
Change-Id: Ib6efba19cc98b499643af06f7b13d207a4637300"
wikimedia/operations-puppet,modules/profile/manifests/analytics/client/limits.pp,"statistics::explorer hosts: refactor and improve cgroups implementation

Previously, cgroups were set by both
modules/profile/manifests/analytics/client/limits.pp
and modules/statistics/manifests/optimize.pp .

This leads to unexpected behavior from the servers,
and confusion for the humans. Consolidate cgroup
config in limits.pp, while updating the config itself
based on recent observations.

Hosts: stat1011.eqiad.wmnet
Bug: T377734
Change-Id: Ic1e2b19bdb4867ca52d4fa46078c1882238a20d1"
wikimedia/operations-puppet,modules/profile/manifests/statistics/explorer.pp,"statistics::explorer hosts: refactor and improve cgroups implementation

Previously, cgroups were set by both
modules/profile/manifests/analytics/client/limits.pp
and modules/statistics/manifests/optimize.pp .

This leads to unexpected behavior from the servers,
and confusion for the humans. Consolidate cgroup
config in limits.pp, while updating the config itself
based on recent observations.

Hosts: stat1011.eqiad.wmnet
Bug: T377734
Change-Id: Ic1e2b19bdb4867ca52d4fa46078c1882238a20d1"
wikimedia/operations-puppet,modules/profile/templates/analytics/client/limits/individual-user-resource-control.conf.erb,"statistics::explorer hosts: refactor and improve cgroups implementation

Previously, cgroups were set by both
modules/profile/manifests/analytics/client/limits.pp
and modules/statistics/manifests/optimize.pp .

This leads to unexpected behavior from the servers,
and confusion for the humans. Consolidate cgroup
config in limits.pp, while updating the config itself
based on recent observations.

Hosts: stat1011.eqiad.wmnet
Bug: T377734
Change-Id: Ic1e2b19bdb4867ca52d4fa46078c1882238a20d1"
wikimedia/operations-puppet,modules/profile/templates/analytics/client/limits/total-user-resource-control.conf.erb,"statistics::explorer hosts: refactor and improve cgroups implementation

Previously, cgroups were set by both
modules/profile/manifests/analytics/client/limits.pp
and modules/statistics/manifests/optimize.pp .

This leads to unexpected behavior from the servers,
and confusion for the humans. Consolidate cgroup
config in limits.pp, while updating the config itself
based on recent observations.

Hosts: stat1011.eqiad.wmnet
Bug: T377734
Change-Id: Ic1e2b19bdb4867ca52d4fa46078c1882238a20d1"
wikimedia/operations-puppet,modules/profile/templates/analytics/client/limits/user-resource-control.conf.erb,"statistics::explorer hosts: refactor and improve cgroups implementation

Previously, cgroups were set by both
modules/profile/manifests/analytics/client/limits.pp
and modules/statistics/manifests/optimize.pp .

This leads to unexpected behavior from the servers,
and confusion for the humans. Consolidate cgroup
config in limits.pp, while updating the config itself
based on recent observations.

Hosts: stat1011.eqiad.wmnet
Bug: T377734
Change-Id: Ic1e2b19bdb4867ca52d4fa46078c1882238a20d1"
wikimedia/operations-puppet,modules/statistics/manifests/optimize.pp,"statistics::explorer hosts: refactor and improve cgroups implementation

Previously, cgroups were set by both
modules/profile/manifests/analytics/client/limits.pp
and modules/statistics/manifests/optimize.pp .

This leads to unexpected behavior from the servers,
and confusion for the humans. Consolidate cgroup
config in limits.pp, while updating the config itself
based on recent observations.

Hosts: stat1011.eqiad.wmnet
Bug: T377734
Change-Id: Ic1e2b19bdb4867ca52d4fa46078c1882238a20d1"
wikimedia/operations-puppet,modules/profile/manifests/toolforge/apt_pinning.pp,"toolforge: apt_pinning: fix repeated entry

Repeated resource name is wrong.

Hosts: re:tools-bastion-.*
Change-Id: I869455e1dd14bb65ae5f9c2b055ba29124f6b2a7
Signed-off-by: Arturo Borrero Gonzalez <aborrero@wikimedia.org>"
wikimedia/operations-puppet,modules/profile/manifests/firewall.pp,"Revert ""profile::firewall: separate ipv4 and ipv6 in nftables BL...""

Revert submission 1076666-nftables-separate-blocked-nets-2

Reason for revert: confd error function ""strings"" not defined

Reverted changes: /r/q/submissionid:1076666-nftables-separate-blocked-nets-2

Bug: T348734
Change-Id: I960e3c111058248d522432a83345e62dbfcd6123"
wikimedia/operations-puppet,modules/profile/manifests/firewall.pp,"profile::firewall: separate ipv4 and ipv6 in nftables BLOCKED_NETS

This change separates the common list of BLOCKED_NETS into separate
nftables set. nftables has limitations when mixing ipv4 and ipv6. So
two separate sets are used (siliar to the other sets like
PRODUCTION_NETWORKS).

This change tries to seperate the ipv4 and ipv6 IPs using just
""strings.Contains"" because the regex in Iadd21cde246edcda5b8935fc5becf035b4b5c952
failed. It's probably not the best implementation and I'm not sure if it
should be strings.Contains or just contains (like in helm templating
for example).

I looked at https://docs.gomplate.ca/functions/strings/

Bug: T348734
Change-Id: I1cc6d60adfead5b2efddb332b2b47304fa02a998"
wikimedia/operations-puppet,modules/profile/manifests/ircstream.pp,"P:ircstream temporarily disable alerting

The connected clients metric is currently show around 30 clients being
disconnected every 15 minutes. This could be the TCP blackbox
scraper/alerting, as this does not correctly close the IRC connection
after probing.

Change-Id: Ieec4e2eee43be81d89babb6fd74a084937193f0d"
wikimedia/operations-puppet,modules/profile/manifests/toolforge/apt_pinning.pp,"toolforge: apt_pinning: drop more unused pinning

The apt pinning that this patch is dropping were mostly used in the old
GridEngine times, where the execution runtime environment for user jobs
had a direct dependency on the LDAP system.

This is no longer the case with the current Kubernetes-based job system.

Change-Id: I2bf3bd992df44919294d8187e7cc439cd60d9dd8
Signed-off-by: Arturo Borrero Gonzalez <aborrero@wikimedia.org>"
wikimedia/operations-puppet,modules/apereo_cas/manifests/init.pp,"Allow CAS to have Redis supported enabled in overlay.

Enabling Redis support in the WAR overlay will cause CAS to expect to be
able connect to a Redis host, and will refuse to start without being
able to located a Redis host.

Disable the Redis feature by default to allow deployment of new overlay.

Bug: T377728
Change-Id: I471089f856fe3d77e461f0292b67067597d4edbb"
wikimedia/operations-puppet,modules/apereo_cas/templates/cas.properties.erb,"Allow CAS to have Redis supported enabled in overlay.

Enabling Redis support in the WAR overlay will cause CAS to expect to be
able connect to a Redis host, and will refuse to start without being
able to located a Redis host.

Disable the Redis feature by default to allow deployment of new overlay.

Bug: T377728
Change-Id: I471089f856fe3d77e461f0292b67067597d4edbb"
wikimedia/operations-puppet,modules/profile/manifests/idp.pp,"Allow CAS to have Redis supported enabled in overlay.

Enabling Redis support in the WAR overlay will cause CAS to expect to be
able connect to a Redis host, and will refuse to start without being
able to located a Redis host.

Disable the Redis feature by default to allow deployment of new overlay.

Bug: T377728
Change-Id: I471089f856fe3d77e461f0292b67067597d4edbb"
wikimedia/operations-puppet,manifests/site.pp,"mediabackups: Setup new host for mediabackups backup1012

backup1012 and backup2012 will be new backup storage hosts
for mediabackups infrastructure. For now, install the software
and configuration at the first one, but do not pool it yet.

backup2012 is not yet ready hardware wise, but will receive the
same treatment when it is ready.

Disable temporarily notifications on backup1012 so that it
doesn't alert while it is being setup.

Bug: T376892
Change-Id: I9c5b08299e578eb7dcea6e7bf30cdc100d4448b1"
wikimedia/operations-puppet,modules/profile/manifests/webperf/site.pp,"webperf: install php-mbstring

Why:

- excimer-ui-server will require the mbstring PHP extension once
  Ie6674a3418a4041b28f8742f34f90ded7b694d9a lands.

What:

- Install the php-mbstring package to provide the extension.

Bug: T377433
Change-Id: Ib51b8daff0ccaa71d8a4f49d928e85d79472c2a9"
